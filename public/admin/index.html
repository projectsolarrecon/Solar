<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>SOLAR Admin</title>

    <style>
      body{font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;max-width:760px;margin:2rem auto;padding:0 1rem}
      #status{padding:.75rem 1rem;border-radius:8px;background:#f8fafc;border:1px solid #e5e7eb}
      .ok{color:#166534;background:#ecfdf5;border-color:#bbf7d0}
      .warn{color:#92400e;background:#fff7ed;border-color:#fed7aa}
      .err{color:#991b1b;background:#fef2f2;border-color:#fecaca}
      code{background:#f1f5f9;padding:2px 4px;border-radius:4px}
      .small{font-size:.9rem;opacity:.85}
    </style>

    <!-- Netlify Identity (needed for login button) -->
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

    <script>
      // Show messages while we diagnose
      function msg(text, cls){ 
        var s=document.getElementById('status'); 
        s.className=cls||''; 
        s.textContent=text; 
      }

      // 1) Check config.yml exists and is reachable
      async function checkConfig() {
        try {
          const res = await fetch('./config.yml?cachebust=' + Date.now());
          if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
          const yml = await res.text();
          if (!/backend:/i.test(yml)) throw new Error('config.yml loaded but missing "backend:" key');
          msg('config.yml found ✔️', 'ok');
          return true;
        } catch (e) {
          msg('Could not load /admin/config.yml → ' + e.message +
              '. Make sure the file exists at public/admin/config.yml (lowercase).', 'err');
          return false;
        }
      }

      // 2) Load Decap from two CDNs (fallback if first fails)
      function loadDecap() {
        return new Promise((resolve, reject) => {
          const urls = [
            "https://cdn.jsdelivr.net/npm/decap-cms@^3/dist/decap-cms.min.js",
            "https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.min.js"
          ];
          function tryNext(i){
            if(i>=urls.length){ return reject(new Error('Could not load Decap CMS script from CDNs')); }
            const s=document.createElement('script');
            s.src=urls[i];
            s.onload=()=>resolve();
            s.onerror=()=>tryNext(i+1);
            document.head.appendChild(s);
          }
          tryNext(0);
        });
      }

      // 3) Run
      (async function(){
        msg('Checking config.yml…','warn');
        const ok = await checkConfig();
        if(!ok) return;
        msg('Loading Decap CMS…','warn');
        try {
          await loadDecap();
          msg('Decap loaded. Initializing…','ok');
          // Let Decap auto-initialize and read config.yml
          // Nothing else to do here.
        } catch (e) {
          msg('Failed to load Decap CMS → ' + e.message, 'err');
        }
      })();

      // 4) Catch any runtime errors and display them
      window.onerror = function (msgText, src, line, col, err) {
        msg('JS error: ' + msgText + (src?(' @ ' + src + ':' + line + ':' + col):''), 'err');
      };
    </script>
  </head>
  <body>
    <div id="status" class="warn">Starting…</div>
  </body>
</html>
